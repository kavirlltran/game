let userAnswers = []; // Mảng lưu đáp án của từng câu

function loadQuestion() {
  clearInterval(timerInterval);
  imageWrapper.innerHTML = "";
  remainingTime = viewTime;
  answerSelected = false;
  canSelect = false;
  nextBtn.disabled = true;
  
  // Kiểm tra đáp án đã lưu của câu hỏi hiện tại (nếu có)
  let savedAnswer = userAnswers[currentQuestionIndex];
  
  // Cập nhật trạng thái cho nút Back: nếu là câu hỏi đầu tiên thì vô hiệu hóa
  backBtn.disabled = currentQuestionIndex === 0;
  
  // Hiển thị tiêu đề câu hỏi
  questionTitle.textContent = `Question ${currentQuestionIndex + 1}`;
  
  const q = questions[currentQuestionIndex];
  const allImages = [q.correct, ...q.distractors];
  shuffleArray(allImages);
  
  allImages.forEach((imgSrc, index) => {
    const item = document.createElement("div");
    item.className = "image-item";

    const label = document.createElement("div");
    label.className = "number-label";
    label.textContent = (index + 1).toString();

    const container = document.createElement("div");
    container.className = "image-container";

    const img = document.createElement("img");
    img.src = imgSrc;
    img.alt = "option";

    const cover = document.createElement("div");
    cover.className = "cover";

    const checkmark = document.createElement("div");
    checkmark.className = "checkmark";
    checkmark.textContent = "✓";

    const wrongmark = document.createElement("div");
    wrongmark.className = "wrongmark";
    wrongmark.textContent = "✗";

    // Nếu đã lưu đáp án cho câu hỏi này, hiển thị trạng thái đã chọn
    if (savedAnswer && savedAnswer === imgSrc) {
      if (imgSrc === q.correct) {
         checkmark.style.display = "block";
      } else {
         wrongmark.style.display = "block";
      }
      // Vô hiệu hóa lựa chọn nếu không cho phép thay đổi
      container.style.pointerEvents = "none";
    }

    container.addEventListener("click", () => {
      if (!canSelect) return;
      cover.classList.remove("show");
      // Nếu người dùng chọn đáp án đúng
      if (imgSrc === q.correct) {
        answerSelected = true;
        checkmark.style.display = "block";
        score++;
        userAnswers[currentQuestionIndex] = imgSrc; // Lưu đáp án
        disableAllClicks();
        nextBtn.disabled = false;
      } else {
        wrongmark.style.display = "block";
        userAnswers[currentQuestionIndex] = imgSrc; // Lưu đáp án
        audioWrong.play();
        setTimeout(() => {
          wrongmark.style.display = "none";
          cover.classList.add("show");
        }, 1000);
      }
    });

    container.appendChild(img);
    container.appendChild(cover);
    container.appendChild(checkmark);
    container.appendChild(wrongmark);
    item.appendChild(label);
    item.appendChild(container);
    imageWrapper.appendChild(item);
  });
  
  // Đợi 1 giây trước khi bắt đầu đếm ngược và phát nhạc "tiktak.mp3"
  setTimeout(() => {
    tiktakAudio.play().catch(err => console.log("Tiktak autoplay bị chặn:", err));
    timerInterval = setInterval(() => {
      remainingTime--;
      updateTimerDisplay();
      if (remainingTime <= 0) {
        clearInterval(timerInterval);
        tiktakAudio.pause();
        tiktakAudio.currentTime = 0;
        showAllCovers();
        canSelect = true;
        // Cập nhật tiêu đề với từ vựng của câu hỏi
        questionTitle.textContent = `Question ${currentQuestionIndex + 1}: ${q.word}`;
      }
    }, 1000);
  }, 1000);
}
